<!-- Main JavaScript -->
<script src="/assets/js/main.js" defer></script>

<!-- Shopping Cart -->
<script src="/assets/js/cart.js" defer></script>

<!-- Page-specific scripts -->
{% if page.url.startsWith("/shop/") %}
<script src="/assets/js/ecommerce.js" defer></script>
{% endif %}

{% if page.url.startsWith("/checkout/") %}
<script src="/assets/js/payment.js" defer></script>
{% endif %}

{% if page.url == "/contact/" %}
<script src="/assets/js/contact.js" defer></script>
{% endif %}

<!-- Service Worker Registration -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('SW registered: ', registration);
        })
        .catch(registrationError => {
          console.log('SW registration failed: ', registrationError);
        });
    });
  }
</script>

<!-- Analytics -->
{% if site.analytics.googleAnalyticsId and site.environment == 'production' %}
<!-- Google Analytics 4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{ site.analytics.googleAnalyticsId }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ site.analytics.googleAnalyticsId }}', {
    anonymize_ip: true,
    cookie_flags: 'SameSite=None;Secure'
  });
  
  // Track page views
  gtag('event', 'page_view', {
    page_title: document.title,
    page_location: window.location.href
  });
</script>
{% endif %}

{% if site.analytics.googleTagManagerId and site.environment == 'production' %}
<!-- Google Tag Manager -->
<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','{{ site.analytics.googleTagManagerId }}');
</script>
{% endif %}

{% if site.analytics.facebookPixelId and site.environment == 'production' %}
<!-- Facebook Pixel -->
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window,document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  
  fbq('init', '{{ site.analytics.facebookPixelId }}');
  fbq('track', 'PageView');
</script>
<noscript>
  <img height="1" width="1" style="display:none"
       src="https://www.facebook.com/tr?id={{ site.analytics.facebookPixelId }}&ev=PageView&noscript=1"/>
</noscript>
{% endif %}

{% if site.analytics.hotjarId and site.environment == 'production' %}
<!-- Hotjar Tracking Code -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:{{ site.analytics.hotjarId }},hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
{% endif %}

<!-- Cookie Consent (GDPR Compliance) -->
<script>
  // Cookie consent handling
  document.addEventListener('DOMContentLoaded', function() {
    const cookieConsent = localStorage.getItem('cookieConsent');
    
    if (!cookieConsent) {
      showCookieConsent();
    }
    
    function showCookieConsent() {
      const consentBanner = document.createElement('div');
      consentBanner.className = 'cookie-consent';
      consentBanner.innerHTML = `
        <div class="cookie-consent__content">
          <p>Utilizamos cookies para mejorar tu experiencia de navegación. Al continuar navegando, aceptas nuestro uso de cookies.</p>
          <div class="cookie-consent__actions">
            <button class="btn btn-primary" data-accept>Aceptar</button>
            <button class="btn btn-secondary" data-decline>Rechazar</button>
            <a href="/privacy/" class="cookie-consent__link">Más información</a>
          </div>
        </div>
      `;
      
      document.body.appendChild(consentBanner);
      
      // Handle consent actions
      consentBanner.querySelector('[data-accept]').addEventListener('click', () => {
        localStorage.setItem('cookieConsent', 'accepted');
        consentBanner.remove();
        loadAnalytics();
      });
      
      consentBanner.querySelector('[data-decline]').addEventListener('click', () => {
        localStorage.setItem('cookieConsent', 'declined');
        consentBanner.remove();
      });
    }
    
    function loadAnalytics() {
      // Analytics scripts would be loaded here if consent is given
      if (typeof gtag !== 'undefined') {
        gtag('consent', 'update', {
          'analytics_storage': 'granted'
        });
      }
    }
  });
</script>

<!-- Performance optimization -->
<script>
  // Preload important resources
  const preloadResources = [
    '/assets/css/main.css',
    '/assets/js/main.js',
    '/assets/fonts/inter-var.woff2'
  ];
  
  preloadResources.forEach(resource => {
    const link = document.createElement('link');
    link.rel = 'preload';
    link.href = resource;
    
    if (resource.endsWith('.css')) {
      link.as = 'style';
    } else if (resource.endsWith('.js')) {
      link.as = 'script';
    } else if (resource.includes('font')) {
      link.as = 'font';
      link.type = 'font/woff2';
      link.crossOrigin = 'anonymous';
    }
    
    document.head.appendChild(link);
  });
</script>

<!-- Error tracking -->
<script>
  window.addEventListener('error', function(e) {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'exception', {
        'description': e.error.toString(),
        'fatal': false
      });
    }
    console.error('JavaScript Error:', e.error);
  });
  
  window.addEventListener('unhandledrejection', function(e) {
    if (typeof gtag !== 'undefined') {
      gtag('event', 'exception', {
        'description': e.reason.toString(),
        'fatal': false
      });
    }
    console.error('Unhandled Promise Rejection:', e.reason);
  });
</script>